services:
  linux-fs:
    build: ./server
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - API_KEY=${API_KEY:?API_KEY is required}
      - HOST=0.0.0.0
      - PORT=8080
      - DATA_DIR=/data
      - DEFAULT_MAX_REPO_SIZE=${DEFAULT_MAX_REPO_SIZE:-1073741824}
      - MAX_UPLOAD_SIZE=${MAX_UPLOAD_SIZE:-104857600}
      - SNAPSHOT_INTERVAL_SECS=${SNAPSHOT_INTERVAL_SECS:-300}
      - TTL_SWEEP_INTERVAL_SECS=${TTL_SWEEP_INTERVAL_SECS:-60}
      - COMMAND_TIMEOUT_SECS=${COMMAND_TIMEOUT_SECS:-30}
      - COMMAND_MAX_OUTPUT_BYTES=${COMMAND_MAX_OUTPUT_BYTES:-10485760}
      - CACHE_MAX_BYTES=${CACHE_MAX_BYTES:-268435456}
      - MAX_CONCURRENT_COMMANDS=${MAX_CONCURRENT_COMMANDS:-10}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-*}
    volumes:
      - linux-fs-data:/data
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
    read_only: true
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=256M
    restart: unless-stopped

volumes:
  linux-fs-data:
